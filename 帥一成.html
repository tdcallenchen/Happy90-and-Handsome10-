<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>快樂九成帥一成team</title>
<style>
:root { 
  --bg:#cce7ff; --accent:#e25b77; --dark:#000; --light:#fff; 
  --male:#8fc1ff; --female:#ffb6c1; --winner:#3cb371; 
}
body{
  font-family:'Segoe UI',sans-serif;margin:0;padding:20px;
  background:var(--bg);display:flex;flex-direction:column;
  align-items:center;color:var(--dark);
}
h1{text-align:center;color:var(--accent);font-size:28px;font-weight:bold;margin-bottom:15px;display:flex;align-items:center;justify-content:center;gap:10px;cursor:pointer;}
h1 .logo{height:8vw;max-height:100px;min-height:60px;width:auto;}
#controls{text-align:center;margin:15px 0;}
#newPlayer{padding:8px 14px;width:180px;border:1px solid var(--accent);border-radius:6px;font-size:15px;}
select{padding:8px;border-radius:6px;border:1px solid var(--accent);font-size:15px;}
button{font-size:15px;padding:10px 16px;margin-left:6px;border:none;border-radius:12px;background-color:var(--accent);color:var(--light);cursor:pointer;font-weight:bold;transition:0.3s;}
button:hover{background-color:#d64a6a;}
.delete-mode-btn.active{background-color:#c63f55 !important;}
.container{display:flex;justify-content:center;align-items:flex-start;gap:20px;width:95%;max-width:1600px;}
.right-side{display:flex;flex-direction:column;gap:20px;flex:2;}
.courts,.waiting{display:flex;gap:20px;}
.area{flex:1;background:var(--light);border:2px solid var(--accent);border-radius:20px;padding:10px;box-shadow:0 3px 10px rgba(0,0,0,0.1);display:flex;flex-direction:column;height:450px;min-width:220px;}
.area h3{text-align:center;color:var(--accent);margin:8px 0;font-size:18px;font-weight:bold;}
.player-zone{flex-grow:1;overflow-y:auto;}
#bench{flex:1;max-width:260px;height:945px;}
.player{position:relative;padding:10px 12px;margin:8px 0;background:#fff4f6;border:2px solid var(--accent);border-radius:14px;font-size:16px;font-weight:bold;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:0.2s;}
.player.male{background:var(--male);}
.player.female{background:var(--female);}
.player.winner{background-color:var(--winner)!important;color:#fff;}
.player .delete-x{display:none;position:absolute;left:6px;top:50%;transform:translateY(-50%);width:20px;height:20px;background:transparent;color:#c63f55;font-size:18px;border:none;cursor:pointer;opacity:0.8;}
.player.delete-mode .delete-x{display:block;}
.player-name{flex-grow:1;text-align:center;}
.player .win-rate{margin-left:6px;font-size:14px;color:var(--dark);}
.area-controls{text-align:center;margin-top:6px;}
#adminControls{text-align:center;margin:10px;display:none;}
#recordModal,#rankModal{display:none;position:fixed;top:10%;left:50%;transform:translateX(-50%);width:600px;max-height:70%;overflow-y:auto;background:#fff;border:2px solid var(--accent);border-radius:16px;box-shadow:0 5px 15px rgba(0,0,0,0.3);z-index:1000;padding:16px;}
#recordContent,#rankContent{font-size:14px;line-height:1.4;white-space:nowrap;overflow-x:auto;}
.rank-section h4{color:var(--accent);text-align:center;margin:6px 0;}
.rank-table{width:100%;border-collapse:collapse;}
.rank-table td,.rank-table th{border-bottom:1px solid #eee;padding:6px;text-align:center;}
.show-more{text-align:center;color:var(--accent);cursor:pointer;font-weight:bold;}
@media(max-width:768px){
  h1{font-size:22px;}
  .container{flex-direction:column;align-items:stretch;}
  .courts,.waiting{flex-direction:column;}
  #bench{max-width:100%;height:auto;}
  .area{height:auto;}
  #recordModal,#rankModal{width:90%;}
}
</style>
<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCLUmagiUpLd0qRUQ-TyoFt7hwrNK7xVDY",
  authDomain: "havix-b6fe2.firebaseapp.com",
  databaseURL: "https://havix-b6fe2-default-rtdb.firebaseio.com",
  projectId: "havix-b6fe2",
  storageBucket: "havix-b6fe2.appspot.com",
  messagingSenderId: "731514229274",
  appId: "1:731514229274:web:1f45a163f223e9fb79f7a3",
  measurementId: "G-YHH49P39XZ"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

export { db, ref, set, onValue };
</script>
</head>
<body>
<h1 id="title"><img src="logo.png" class="logo" alt="logo">快樂九成帥一成team</h1>

<div id="controls">
<input type="text" id="newPlayer" placeholder="輸入球員名稱">
<select id="gender"><option value="M">男</option><option value="F">女</option></select>
<button onclick="addPlayer()">新增球員</button>
<button id="randomBtn">隨機分組</button>
<button id="resetBtn">重置今日</button>
<button id="deleteModeBtn" class="delete-mode-btn">刪除球員</button>
</div>

<div id="adminControls">
<button id="showRecordBtn">查看今日紀錄</button>
<button id="showRankBtn">排行榜</button>
</div>

<div class="container">
<div class="area" id="bench"><h3>休息區</h3><div class="player-zone" id="bench-zone"></div></div>

<div class="right-side">
  <div class="courts">
    <div class="area" id="court1"><h3>1號場</h3><div class="player-zone" id="court1-zone"></div><div class="area-controls"><button onclick="endMatch('court1')">結束比賽</button></div></div>
    <div class="area" id="court2"><h3>2號場</h3><div class="player-zone" id="court2-zone"></div><div class="area-controls"><button onclick="endMatch('court2')">結束比賽</button></div></div>
    <div class="area" id="court3"><h3>3號場</h3><div class="player-zone" id="court3-zone"></div><div class="area-controls"><button onclick="endMatch('court3')">結束比賽</button></div></div>
  </div>
  <div class="waiting">
    <div class="area" id="waitingA"><h3>等待順位1</h3><div class="player-zone" id="waitingA-zone"></div></div>
    <div class="area" id="waitingB"><h3>等待順位2</h3><div class="player-zone" id="waitingB-zone"></div></div>
    <div class="area" id="waitingC"><h3>等待順位3</h3><div class="player-zone" id="waitingC-zone"></div></div>
  </div>
</div>
</div>

<div id="recordModal">
<h3 style="text-align:center;color:var(--accent);">今日比賽紀錄</h3>
<div id="recordContent"></div>
<button onclick="closeModal('recordModal')" style="margin:auto;display:block;">關閉</button>
</div>

<div id="rankModal">
<h3 style="text-align:center;color:var(--accent);">排行榜</h3>
<div id="rankContent"></div>
<button onclick="closeModal('rankModal')" style="margin:auto;display:block;">關閉</button>
</div>

<audio id="victorySound" src="https://actions.google.com/sounds/v1/celebration/party_winner.ogg"></audio>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script type="module">
import { db, ref, set, onValue } from "./firebase.js"; // 假設上面 Firebase module 在 firebase.js

const areaIds=['bench-zone','court1-zone','court2-zone','court3-zone','waitingA-zone','waitingB-zone','waitingC-zone'];
const maxPlayersPerArea=4;
let deleteMode=false;
let playerData={}, matchRecord=[], matchCounter={court1:0,court2:0,court3:0};
let maleRankData=[], femaleRankData=[];

// ===== Firebase 讀取 =====
onValue(ref(db,'playerData'),snapshot=>{
  if(snapshot.exists()) playerData=snapshot.val();
  loadState();
});
onValue(ref(db,'matchRecord'),snapshot=>{
  if(snapshot.exists()) matchRecord=snapshot.val();
});

// ===== 建立球員 DOM =====
function createPlayer(name,gender,zone){
  const div=document.createElement('div');
  div.className='player '+(gender==='M'?'male':'female');
  div.dataset.name=name; div.dataset.gender=gender;
  const span=document.createElement('span'); span.className='player-name'; span.textContent=name;
  const rate=document.createElement('span'); rate.className='win-rate';
  rate.textContent=(playerData[name].todayTotal?Math.round(playerData[name].todayWins/playerData[name].todayTotal*100):0)+'%';
  span.appendChild(rate); div.appendChild(span); zone.appendChild(div);
}

// ===== 儲存到 Firebase =====
function saveFirebase(){
  set(ref(db,'playerData'),playerData);
  set(ref(db,'matchRecord'),matchRecord);
}

// ===== 載入 DOM 狀態 =====
function loadState(){
  areaIds.forEach(id=>{
    const zone=document.getElementById(id); zone.innerHTML='';
    // 根據 playerData 排到休息區
    if(id==='bench-zone'){
      for(const [name,p] of Object.entries(playerData)){
        createPlayer(name,p.gender,zone);
      }
    }
  });
  initSortable();
  updateRank();
}

// ===== 新增球員 =====
window.addPlayer=()=>{
  const name=document.getElementById('newPlayer').value.trim();
  const gender=document.getElementById('gender').value;
  if(!name)return;
  if(!playerData[name]) playerData[name]={wins:0,total:0,todayWins:0,todayTotal:0,gender};
  createPlayer(name,gender,document.getElementById('bench-zone'));
  document.getElementById('newPlayer').value='';
  saveFirebase(); updateRank();
}

// ===== 排行榜 =====
function updateRank(){
  const males=[],females=[];
  for(const [name,p] of Object.entries(playerData)){
    const lose=(p.total||0)-(p.wins||0);
    const obj={name,wins:p.wins||0,lose,rate:(p.total?Math.round(p.wins/p.total*100):0)};
    (p.gender==='M'?males:females).push(obj);
  }
  males.sort((a,b)=>b.wins-a.wins); females.sort((a,b)=>b.wins-a.wins);
  maleRankData=males; femaleRankData=females;

  const tableHTML=(arr,title,gender)=>{
    let rows=arr.slice(0,20).map((p,i)=>
      `<tr><td>${i+1}</td><td>${p.name}</td><td>${p.wins}</td><td>${p.lose}</td><td>${p.rate}%</td><td><button onclick="deleteHistory('${p.name}')">✕</button></td></tr>`
    ).join('');
    let more=arr.length>20?`<div class='show-more' onclick='showMore("${gender}")'>展開更多</div>`:'';
    return `<div class='rank-section' id='${gender}RankSection'><h4>${title}</h4><table class='rank-table'><tr><th>#</th><th>姓名</th><th>勝場</th><th>敗場</th><th>勝率</th><th>刪除</th></tr>${rows}</table>${more}</div>`;
  };
  document.getElementById('rankContent').innerHTML=tableHTML(males,'男生','male')+tableHTML(females,'女生','female');
}

window.showMore=(gender)=>{
  const section=document.getElementById(`${gender}RankSection`);
  const table=section.querySelector('.rank-table');
  const allPlayers=gender==='male'?maleRankData:femaleRankData;
  const shown=table.querySelectorAll('tr').length-1;
  for(let i=shown;i<allPlayers.length;i++){
    const p=allPlayers[i];
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${p.name}</td><td>${p.wins}</td><td>${p.lose}</td><td>${p.rate}%</td><td><button onclick="deleteHistory('${p.name}')">✕</button></td>`;
    table.appendChild(tr);
  }
  section.querySelector('.show-more')?.remove();
}

window.deleteHistory=(name)=>{
  if(confirm('確定刪除歷史資料？')){
    delete playerData[name]; saveFirebase(); updateRank(); loadState();
  }
}

window.closeModal=(id)=>{document.getElementById(id).style.display='none';}

// ===== 模態框 =====
document.getElementById('showRecordBtn').onclick=()=>{
  document.getElementById('recordContent').innerHTML=matchRecord.map(r=>`<div>${r}</div>`).join('');
  document.getElementById('recordModal').style.display='block';
};
document.getElementById('showRankBtn').onclick=()=>{
  updateRank();
  document.getElementById('rankModal').style.display='block';
};

// ===== 管理員隱藏 =====
let clickCount=0;
document.getElementById('title').onclick=()=>{
  clickCount++;
  if(clickCount>=3){
    document.getElementById('adminControls').style.display=document.getElementById('adminControls').style.display==='block'?'none':'block';
    clickCount=0;
  }
  setTimeout(()=>{clickCount=0;},1000);
};

// ===== 刪除模式 =====
document.getElementById('deleteModeBtn').onclick=function(){
  deleteMode=!deleteMode;
  this.classList.toggle('active',deleteMode);
  areaIds.forEach(id=>{
    document.getElementById(id).querySelectorAll('.player').forEach(p=>{
      p.classList.toggle('delete-mode',deleteMode);
      if(deleteMode && !p.querySelector('.delete-x')){
        const btn=document.createElement('button');btn.className='delete-x';btn.textContent='✕';
        btn.onclick=e=>{e.stopPropagation();p.remove();saveFirebase();updateRank();};
        p.insertBefore(btn,p.firstChild);
      }else if(!deleteMode){p.querySelector('.delete-x')?.remove();}
    });
  });
};

// ===== 拖曳 =====
function initSortable(){
  areaIds.forEach(id=>{
    new Sortable(document.getElementById(id),{
      group:'players',animation:150,
      onAdd:e=>{
        if(e.to.children.length>maxPlayersPerArea){
          alert('人數已達上限，移回休息區');
          document.getElementById('bench-zone').appendChild(e.item);
        }
        saveFirebase();
      },
      onUpdate:saveFirebase
    });
  });
}

// ===== 勝者點擊 =====
['court1-zone','court2-zone','court3-zone'].forEach(cid=>{
  document.getElementById(cid).addEventListener('click',e=>{
    if(!e.target.classList.contains('player-name'))return;
    e.target.parentElement.classList.toggle('winner');
  });
});

// ===== 隨機分組 =====
document.getElementById('randomBtn').onclick=()=>{
  const bench=[...document.querySelectorAll('#bench-zone .player')];
  bench.sort(()=>Math.random()-0.5);
  const zones=[
    document.getElementById('court1-zone'),
    document.getElementById('court2-zone'),
    document.getElementById('court3-zone'),
    document.getElementById('waitingA-zone'),
    document.getElementById('waitingB-zone'),
    document.getElementById('waitingC-zone')
  ];
  zones.forEach(z=>{while(z.children.length<maxPlayersPerArea && bench.length>0) z.appendChild(bench.shift());});
  saveFirebase();
};

// ===== 結束比賽 =====
window.endMatch=(courtId)=>{
  const courtZone=document.getElementById(courtId+'-zone');
  if(courtZone.children.length===0)return;
  const winners=[...courtZone.querySelectorAll('.player.winner')].map(p=>p.dataset.name);
  if(winners.length===0){alert('請先點選勝者');return;}
  document.getElementById('victorySound').play();

  courtZone.querySelectorAll('.player').forEach(p=>{
    const name=p.dataset.name;
    playerData[name].todayTotal=(playerData[name].todayTotal||0)+1;
    if(winners.includes(name)){
      playerData[name].todayWins=(playerData[name].todayWins||0)+1;
      playerData[name].wins=(playerData[name].wins||0)+1;
    }
    playerData[name].total=(playerData[name].total||0)+1;
    p.classList.remove('winner');
  });

  matchCounter[courtId]++;
  const names=[...courtZone.querySelectorAll('.player')].map(p=>p.dataset.name);
  matchRecord.push(`${new Date().toLocaleString()} ${courtId} 比賽${matchCounter[courtId]} 組合: ${names.join(', ')} 勝者: ${winners.join(', ')}`);

  // 勝者與其他回休息區
  const bench=document.getElementById('bench-zone');
  while(courtZone.children.length>0) bench.appendChild(courtZone.children[0]);

  // 等候區補上
  const waits=['waitingA-zone','waitingB-zone','waitingC-zone'];
  waits.forEach((id,i)=>{
    const from=document.getElementById(id);
    let to=document.getElementById(courtId+'-zone');
    if(i>0) to=document.getElementById(waits[i-1]);
    while(from.children.length>0 && to.children.length<maxPlayersPerArea) to.appendChild(from.children[0]);
  });

  saveFirebase();
  updateRank();
};
</script>
</body>
</html>

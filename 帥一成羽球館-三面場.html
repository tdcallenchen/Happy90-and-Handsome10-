<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«æ¨‚ä¹æˆå¸¥ä¸€æˆ</title>
    <style>
        :root {
            --bg: #cce7ff;
            --accent: #e25b77;
            --dark: #000;
            --light: #fff;
            --male: #8fc1ff;
            --female: #ffb6c1;
            --winner: #3cb371;
            --border-radius: 15px;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            margin: 0;
            padding: 10px;
            background: var(--bg);
            color: var(--dark);
            background-image: url('dogg.png'); /* ç¢ºä¿æœ‰æ­¤æª”æ¡ˆæˆ–è‡ªè¡Œæ›´æ›ç¶²å€ */
            background-repeat: no-repeat;
            background-size: auto 60px;
            background-position: right bottom;
            background-attachment: fixed;
        }

        h1 {
            text-align: center;
            color: var(--accent);
            cursor: pointer;
            user-select: none;
            margin: 10px 0;
            font-size: 2rem;
            text-shadow: 1px 1px 0px white;
        }

        /* æ§åˆ¶åˆ— */
        #controls, #adminControls {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        #adminControls { 
            display: none; 
            background: rgba(255, 255, 255, 0.5); 
            padding: 10px; 
            border-radius: var(--border-radius); 
        }

        input, select, button {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--accent);
            font-size: 16px;
        }

        button {
            background-color: var(--accent);
            color: white;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: 0.2s;
        }

        button:hover { opacity: 0.8; transform: translateY(-1px); }
        .delete-mode-btn.active { background-color: #d32f2f !important; }

        /* ==========================================
           é›»è¦–/é›»è…¦å¤§è¢å¹•ä½ˆå±€ (å¯¬åº¦ > 1024px)
        ========================================== */
        @media (min-width: 1025px) {
            .container {
                display: grid;
                grid-template-columns: 280px 1fr;
                gap: 20px;
                max-width: 1600px;
                margin: 0 auto;
            }
            .right-side {
                display: grid;
                grid-template-rows: 1fr 1fr;
                gap: 20px;
            }
            .courts, .waiting {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
            }
            .area { min-height: 320px; }
        }

        /* ==========================================
           æ‰‹æ©Ÿç‰ˆä½ˆå±€ (å¯¬åº¦ <= 1024px)
        ========================================== */
        @media (max-width: 1024px) {
            .container {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            .courts, .waiting {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            #bench { order: 3; } /* ä¼‘æ¯å€åœ¨æœ€ä¸‹é¢ */
            .right-side { order: 1; display: flex; flex-direction: column; gap: 15px; }
            .player { padding: 15px !important; } /* æ‰‹æ©ŸæŒ‰éˆ•åŠ å¤§ */
        }

        /* å…±ç”¨å€åŸŸæ¨£å¼ */
        .area {
            background: var(--light);
            border: 3px solid var(--accent);
            border-radius: var(--border-radius);
            padding: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .area h3 {
            text-align: center;
            color: var(--accent);
            margin: 5px 0 10px 0;
            font-size: 1.2rem;
            border-bottom: 2px dashed var(--bg);
        }

        .player-zone {
            flex-grow: 1;
            overflow-y: auto;
            min-height: 120px;
        }

        /* çƒå“¡å¡ç‰‡ */
        .player {
            position: relative;
            padding: 10px;
            margin: 8px;
            background: #fff4f6;
            border: 2px solid var(--accent);
            border-radius: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            transition: 0.2s;
        }

        .player.male { background: var(--male); border-color: #5a91d4; }
        .player.female { background: var(--female); border-color: #d48da3; }
        .player.winner { background-color: var(--winner) !important; color: white; border-color: #2e8b57; }

        .player-name { flex-grow: 1; text-align: center; }
        .win-rate { font-size: 11px; margin-left: 5px; opacity: 0.8; display: block; }

        .delete-x {
            display: none;
            position: absolute;
            left: 8px;
            color: #d32f2f;
            border: none;
            background: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 20px;
        }
        .player.delete-mode .delete-x { display: block; }

        /* å½ˆçª— */
        .modal {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 90%; max-width: 500px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 2000;
            padding: 20px;
        }

        .rank-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .rank-table th, .rank-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }

    </style>
</head>
<body>

    <h1 id="mainTitle">å¿«æ¨‚ä¹æˆå¸¥ä¸€æˆ</h1>

    <div id="controls">
        <input type="text" id="newPlayer" placeholder="éšŠå“¡åç¨±">
        <select id="gender">
            <option value="M">ç”·</option>
            <option value="F">å¥³</option>
        </select>
        <button onclick="addPlayer()">æ–°å¢éšŠå“¡</button>
        <button onclick="randomGroup()">éš¨æ©Ÿåˆ†çµ„</button>
        <button id="deleteModeBtn">åˆªé™¤æ¨¡å¼</button>
    </div>

    <div id="adminControls">
        <button id="showRankBtn">ğŸ† æŸ¥çœ‹æ’è¡Œæ¦œ</button>
        <button id="resetBtn">âš ï¸ é‡ç½®ä»Šæ—¥æ•¸æ“š</button>
    </div>

    <div class="container">
        <div class="area" id="bench">
            <h3>ä¼‘æ¯å€</h3>
            <div class="player-zone" id="bench-zone"></div>
        </div>

        <div class="right-side">
            <div class="courts">
                <div class="area" id="court1">
                    <h3>å ´åœ° 1</h3>
                    <div class="player-zone" id="court1-zone"></div>
                    <div style="text-align:center; padding-top:10px;">
                        <button onclick="endMatch('court1')">çµæŸæ¯”è³½</button>
                    </div>
                </div>
                <div class="area" id="court2">
                    <h3>å ´åœ° 2</h3>
                    <div class="player-zone" id="court2-zone"></div>
                    <div style="text-align:center; padding-top:10px;">
                        <button onclick="endMatch('court2')">çµæŸæ¯”è³½</button>
                    </div>
                </div>
                <div class="area" id="court3">
                    <h3>å ´åœ° 3</h3>
                    <div class="player-zone" id="court3-zone"></div>
                    <div style="text-align:center; padding-top:10px;">
                        <button onclick="endMatch('court3')">çµæŸæ¯”è³½</button>
                    </div>
                </div>
            </div>

            <div class="waiting">
                <div class="area" id="waitingA"><h3>ç­‰å¾… 1</h3><div class="player-zone" id="waitingA-zone"></div></div>
                <div class="area" id="waitingB"><h3>ç­‰å¾… 2</h3><div class="player-zone" id="waitingB-zone"></div></div>
                <div class="area" id="waitingC"><h3>ç­‰å¾… 3</h3><div class="player-zone" id="waitingC-zone"></div></div>
            </div>
        </div>
    </div>

    <div id="rankModal" class="modal">
        <h3 style="text-align:center; color:var(--accent);">ğŸ† å‹ç‡æ’è¡Œæ¦œ</h3>
        <div id="rankContent" style="max-height: 350px; overflow-y: auto;"></div>
        <button onclick="this.parentElement.style.display='none'" style="margin-top:15px; width:100%; padding:10px;">é—œé–‰</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import Sortable from "https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/+esm";

        // --- Firebase é…ç½® ---
        const firebaseConfig = {
            apiKey: "AIzaSyCLUmagiUpLd0qRUQ-TyoFt7hwrNK7xVDY",
            authDomain: "havix-b6fe2.firebaseapp.com",
            databaseURL: "https://havix-b6fe2-default-rtdb.firebaseio.com",
            projectId: "havix-b6fe2",
            storageBucket: "havix-b6fe2.appspot.com",
            messagingSenderId: "731514229274",
            appId: "1:731514229274:web:1f45a163f223e9fb79f7a3",
            measurementId: "G-YHH49P39XZ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const areaIds = ['bench-zone', 'court1-zone', 'court2-zone', 'court3-zone', 'waitingA-zone', 'waitingB-zone', 'waitingC-zone'];
        let deleteMode = false;
        let isLocalMoving = false;
        let playersStats = {};

        // ç›£è½å…¨å±€å‹ç‡
        onValue(ref(db, 'stats'), (snapshot) => {
            playersStats = snapshot.val() || {};
            refreshWinRates();
        });

        // ç›£è½å„å€çƒå“¡ä½ç½®
        areaIds.forEach(id => {
            onValue(ref(db, id), (snapshot) => {
                if (isLocalMoving) return;
                const data = snapshot.val() || { players: [] };
                const zone = document.getElementById(id);
                zone.innerHTML = '';
                (data.players || []).forEach(p => {
                    zone.appendChild(createPlayerDOM(p.name, p.gender));
                });
            });
        });

        function createPlayerDOM(name, gender) {
            const div = document.createElement('div');
            div.className = `player ${gender === 'M' ? 'male' : 'female'}`;
            div.dataset.name = name;
            div.dataset.gender = gender;
            
            const stats = playersStats[name] || { wins: 0, total: 0 };
            const rate = stats.total ? Math.round((stats.wins / stats.total) * 100) : 0;

            div.innerHTML = `
                <button class="delete-x">âœ•</button>
                <div class="player-name">${name}<span class="win-rate">å‹ç‡: ${rate}%</span></div>
            `;

            if(deleteMode) div.classList.add('delete-mode');

            div.onclick = () => {
                if(div.parentElement.id.includes('court')) {
                    div.classList.toggle('winner');
                }
            };

            div.querySelector('.delete-x').onclick = (e) => {
                e.stopPropagation();
                div.remove();
                syncToDB();
            };

            return div;
        }

        function refreshWinRates() {
            document.querySelectorAll('.player').forEach(p => {
                const name = p.dataset.name;
                const stats = playersStats[name] || { wins: 0, total: 0 };
                const rate = stats.total ? Math.round((stats.wins / stats.total) * 100) : 0;
                const rateSpan = p.querySelector('.win-rate');
                if(rateSpan) rateSpan.textContent = `å‹ç‡: ${rate}%`;
            });
        }

        window.addPlayer = function() {
            const name = document.getElementById('newPlayer').value.trim();
            const gender = document.getElementById('gender').value;
            if(!name) return;
            document.getElementById('bench-zone').appendChild(createPlayerDOM(name, gender));
            document.getElementById('newPlayer').value = '';
            syncToDB();
        };

        function syncToDB() {
            areaIds.forEach(id => {
                const players = [...document.getElementById(id).querySelectorAll('.player')].map(p => ({
                    name: p.dataset.name,
                    gender: p.dataset.gender
                }));
                set(ref(db, id), { players });
            });
            set(ref(db, 'stats'), playersStats);
        }

        // å•Ÿç”¨æ‹–æ‹½
        areaIds.forEach(id => {
            Sortable.create(document.getElementById(id), {
                group: 'players',
                animation: 150,
                onStart: () => { isLocalMoving = true; },
                onEnd: () => { 
                    isLocalMoving = false;
                    syncToDB(); 
                }
            });
        });

        window.endMatch = function(courtId) {
            const courtZone = document.getElementById(courtId + '-zone');
            if(courtZone.children.length === 0) return;

            const winners = [...courtZone.querySelectorAll('.player.winner')].map(p => p.dataset.name);
            
            // æ›´æ–°å‹ç‡æ•¸æ“š
            courtZone.querySelectorAll('.player').forEach(p => {
                const name = p.dataset.name;
                if(!playersStats[name]) playersStats[name] = { wins: 0, total: 0 };
                playersStats[name].total++;
                if(winners.includes(name)) playersStats[name].wins++;
                
                // æ¯”è³½å®Œå›ä¼‘æ¯å€
                document.getElementById('bench-zone').appendChild(p);
                p.classList.remove('winner');
            });

            // è‡ªå‹•éè£œ (Waiting A -> Court -> Waiting B -> Waiting A...)
            const waitQueues = ['waitingA-zone', 'waitingB-zone', 'waitingC-zone'];
            const targetZones = [courtId + '-zone', ...waitQueues];
            for(let i=0; i < targetZones.length - 1; i++) {
                const to = document.getElementById(targetZones[i]);
                const from = document.getElementById(targetZones[i+1]);
                while(from.children.length > 0 && to.children.length < 4) {
                    to.appendChild(from.children[0]);
                }
            }
            syncToDB();
        };

        window.randomGroup = function() {
            const bench = [...document.getElementById('bench-zone').children];
            bench.sort(() => Math.random() - 0.5);
            ['court1-zone','court2-zone','court3-zone','waitingA-zone','waitingB-zone','waitingC-zone'].forEach(tid => {
                const zone = document.getElementById(tid);
                while(zone.children.length < 4 && bench.length > 0) zone.appendChild(bench.shift());
            });
            syncToDB();
        };

        // æ¨™é¡Œé€£é»é–‹å•Ÿç®¡ç†å“¡
        let titleClick = 0;
        document.getElementById('mainTitle').onclick = () => {
            titleClick++;
            if(titleClick >= 3) {
                const admin = document.getElementById('adminControls');
                admin.style.display = admin.style.display === 'flex' ? 'none' : 'flex';
                titleClick = 0;
            }
            setTimeout(() => titleClick = 0, 2000);
        };

        document.getElementById('showRankBtn').onclick = () => {
            const sorted = Object.entries(playersStats)
                .map(([name, s]) => ({ name, ...s, rate: s.total ? Math.round((s.wins/s.total)*100) : 0 }))
                .sort((a, b) => b.rate - a.rate || b.wins - a.wins);

            let html = `<table class="rank-table"><tr><th>çƒå“¡</th><th>å‹å ´</th><th>å‹ç‡</th></tr>`;
            sorted.forEach(p => { html += `<tr><td>${p.name}</td><td>${p.wins}</td><td>${p.rate}%</td></tr>`; });
            html += `</table>`;
            document.getElementById('rankContent').innerHTML = html;
            document.getElementById('rankModal').style.display = 'block';
        };

        document.getElementById('deleteModeBtn').onclick = function() {
            deleteMode = !deleteMode;
            this.classList.toggle('active', deleteMode);
            document.querySelectorAll('.player').forEach(p => p.classList.toggle('delete-mode', deleteMode));
        };

        document.getElementById('resetBtn').onclick = () => {
            if(confirm('é€™å°‡æ¸…é™¤æ‰€æœ‰äººçš„ä»Šæ—¥å‹ç‡ç´€éŒ„èˆ‡ä½ç½®ï¼Œç¢ºå®šå—ï¼Ÿ')) {
                areaIds.forEach(id => set(ref(db, id), { players: [] }));
                set(ref(db, 'stats'), {});
                location.reload();
            }
        };
    </script>
</body>
</html>
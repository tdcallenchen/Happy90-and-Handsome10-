<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¿«æ¨‚ä¹æˆå¸¥ä¸€æˆ</title>
    <style>
        :root {
            --bg: #cce7ff; --accent: #e25b77; --dark: #000; --light: #fff;
            --male: #8fc1ff; --female: #ffb6c1; --winner: #3cb371; --border-radius: 12px;
        }
        html, body { height: 100vh; margin: 0; padding: 0; background: var(--bg); font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; overflow: hidden; }
        body { display: flex; flex-direction: column; padding: 10px; box-sizing: border-box; }
        
        h1 { text-align: center; color: var(--accent); margin: 5px 0; font-size: 2.2rem; cursor: pointer; flex-shrink: 0; }
        
        /* ç®¡ç†åŠŸèƒ½å€ */
        #controls, #adminControls { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; flex-shrink: 0; }
        #adminControls { display: none; background: rgba(255, 255, 255, 0.9); padding: 10px; border-radius: var(--border-radius); border: 2px solid var(--accent); position: absolute; top: 70px; left: 50%; transform: translateX(-50%); z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        
        input, select, button { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--accent); font-size: 14px; }
        button { background-color: var(--accent); color: white; font-weight: bold; cursor: pointer; border: none; }
        .btn-info { background-color: #2196F3; }
        .btn-warning { background-color: #ffa000; }
        .btn-danger { background-color: #d32f2f; }
        #delBtn.active { background-color: #000; color: #fff; animation: pulse 1s infinite; }

        /* ä¸»ä½ˆå±€ï¼šå·¦å´ä¼‘æ¯å€ | å³å´å ´åœ°å±•ç¤º */
        .container { display: grid; grid-template-columns: 200px 1fr; gap: 15px; flex-grow: 1; min-height: 0; }
        .area { background: var(--light); border: 3px solid var(--accent); border-radius: var(--border-radius); padding: 8px; display: flex; flex-direction: column; box-shadow: 0 4px 10px rgba(0,0,0,0.1); min-height: 0; }
        .area h3 { text-align: center; color: var(--accent); margin: 0 0 8px 0; font-size: 1.2rem; border-bottom: 2px dashed var(--bg); flex-shrink: 0; }
        
        .player-zone { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; }
        
        /* çƒå“¡å¡ç‰‡ */
        .player { position: relative; width: 100%; height: 50px; background: #fff; border: 2px solid var(--accent); border-radius: 10px; font-weight: bold; font-size: 18px; display: flex; align-items: center; justify-content: center; cursor: grab; user-select: none; flex-shrink: 0; }
        .player.male { background: var(--male); }
        .player.female { background: var(--female); }
        .player.winner { background-color: var(--winner) !important; color: white; border-color: #2e8b57; }
        .win-rate { font-size: 11px; display: block; opacity: 0.8; margin-top: -2px; text-align: center; }

        /* å³å´æ ¸å¿ƒçœ‹æ¿ */
        .right-side { display: grid; grid-template-rows: 2.2fr 0.8fr 0.4fr; gap: 12px; min-height: 0; }
        
        /* 1-4 è™Ÿå ´ 2x2 */
        .courts { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .courts .player-zone { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; align-content: center; }
        .courts .player { height: 65px; font-size: 20px; }

        /* ç­‰å¾…å€ 1 (å¤§æ©«åˆ—) */
        .waiting-main { display: flex; flex-direction: column; }
        .waiting-main h3 { font-size: 1.4rem; color: #d32f2f; }
        #waitingA-zone { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        #waitingA-zone .player { height: 60px; font-size: 19px; }

        /* å…¶ä»–ç­‰å¾…å€ (åº•éƒ¨å°å€åŸŸ) */
        .waiting-subs { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .waiting-subs .player { height: 35px; font-size: 14px; }
        .waiting-subs h3 { font-size: 0.9rem; margin-bottom: 2px; border-bottom: none; }

        .end-btn { width: 100%; margin-top: 5px; padding: 6px; font-size: 12px; background: #444; color: white; border-radius: 6px; }

        /* Modal æ¨£å¼ */
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 50px rgba(0,0,0,0.5); z-index: 999; }
        .modal-content { max-height: 500px; overflow-y: auto; }
        .rank-table { width: 100%; border-collapse: collapse; }
        .rank-table td { padding: 10px 5px; border-bottom: 1px solid #eee; }

        @media (max-width: 1000px) {
            .container { grid-template-columns: 160px 1fr; }
        }
    </style>
</head>
<body>

    <h1 id="mainTitle">å¿«æ¨‚ä¹æˆå¸¥ä¸€æˆ</h1>
    
    <div id="controls">
        <input type="text" id="newPlayer" placeholder="å§“å" style="width: 80px;">
        <select id="gender"><option value="M">ç”·</option><option value="F">å¥³</option></select>
        <button onclick="addPlayer()">æ–°å¢</button>
        <button id="delBtn" onclick="toggleDeleteMode()">ğŸ—‘ï¸ åˆªé™¤æ¨¡å¼</button>
    </div>

    <div id="adminControls">
        <button id="showRankBtn" class="btn-info">ğŸ† æ­·å²æ’è¡Œæ¦œ</button>
        <button id="showLogBtn" class="btn-info">ğŸ“‹ ä»Šæ—¥å°æˆ°ç´€éŒ„</button>
        <button onclick="resetToday()" class="btn-warning">ğŸ”„ é‡ç½®ä»Šæ—¥ç´€éŒ„</button>
        <button onclick="resetEverything()" class="btn-danger">âš ï¸ é‡ç½®æ­·å²ç´€éŒ„</button>
    </div>

    <div class="container">
        <div class="area" id="bench">
            <h3>ä¼‘æ¯å€</h3>
            <div class="player-zone" id="bench-zone"></div>
        </div>

        <div class="right-side">
            <div class="courts">
                <div class="area" id="court1"><h3>1 è™Ÿå ´</h3><div class="player-zone" id="court1-zone"></div><button class="end-btn" onclick="endMatch('court1')">çµæŸæ¯”è³½</button></div>
                <div class="area" id="court2"><h3>2 è™Ÿå ´</h3><div class="player-zone" id="court2-zone"></div><button class="end-btn" onclick="endMatch('court2')">çµæŸæ¯”è³½</button></div>
                <div class="area" id="court3"><h3>3 è™Ÿå ´</h3><div class="player-zone" id="court3-zone"></div><button class="end-btn" onclick="endMatch('court3')">çµæŸæ¯”è³½</button></div>
                <div class="area" id="court4"><h3>4 è™Ÿå ´</h3><div class="player-zone" id="court4-zone"></div><button class="end-btn" onclick="endMatch('court4')">çµæŸæ¯”è³½</button></div>
            </div>

            <div class="area waiting-main" id="waitingA">
                <h3>ğŸ“¢ é å‚™ä¸Šå ´ (ç­‰å¾… 1)</h3>
                <div class="player-zone" id="waitingA-zone"></div>
            </div>

            <div class="waiting-subs">
                <div class="area" id="waitingB"><h3>ç­‰å¾… 2</h3><div class="player-zone" id="waitingB-zone"></div></div>
                <div class="area" id="waitingC"><h3>ç­‰å¾… 3</h3><div class="player-zone" id="waitingC-zone"></div></div>
                <div class="area" id="waitingD"><h3>ç­‰å¾… 4</h3><div class="player-zone" id="waitingD-zone"></div></div>
            </div>
        </div>
    </div>

    <div id="rankModal" class="modal"><h3 style="text-align:center;">ğŸ† æ­·å²æ’è¡Œæ¦œ</h3><div id="rankContent" class="modal-content"></div><button onclick="this.parentElement.style.display='none'" style="width:100%; margin-top:15px; padding:10px;">é—œé–‰</button></div>
    <div id="logModal" class="modal"><h3 style="text-align:center;">ğŸ“‹ ä»Šæ—¥å°æˆ°ç´€éŒ„</h3><div id="logContent" class="modal-content"></div><button onclick="this.parentElement.style.display='none'" style="width:100%; margin-top:15px; padding:10px;">é—œé–‰</button></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import Sortable from "https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/+esm";

        // Firebase é…ç½® (è«‹ä¿ç•™æ‚¨åŸæœ‰çš„é…ç½®)
        const firebaseConfig = {
            apiKey: "AIzaSyCLUmagiUpLd0qRUQ-TyoFt7hwrNK7xVDY",
            authDomain: "havix-b6fe2.firebaseapp.com",
            databaseURL: "https://havix-b6fe2-default-rtdb.firebaseio.com",
            projectId: "havix-b6fe2",
            storageBucket: "havix-b6fe2.appspot.com",
            messagingSenderId: "731514229274",
            appId: "1:731514229274:web:1f45a163f223e9fb79f7a3"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const allZones = ['bench-zone', 'court1-zone', 'court2-zone', 'court3-zone', 'court4-zone', 'waitingA-zone', 'waitingB-zone', 'waitingC-zone', 'waitingD-zone'];
        const courtZones = ['court1-zone', 'court2-zone', 'court3-zone', 'court4-zone'];
        const waitZones = ['waitingA-zone', 'waitingB-zone', 'waitingC-zone', 'waitingD-zone'];

        let isLocalMoving = false, isDeleteMode = false, todayStats = {}, historyStats = {}, logs = [];

        // ç›£è½æ•¸æ“š
        onValue(ref(db, 'today_stats'), (s) => { todayStats = s.val() || {}; refreshWinRates(); });
        onValue(ref(db, 'history_stats'), (s) => { historyStats = s.val() || {}; });
        onValue(ref(db, 'match_logs'), (s) => { logs = Object.values(s.val() || {}).reverse(); });

        allZones.forEach(id => {
            onValue(ref(db, id), (snapshot) => {
                if (isLocalMoving) return;
                const zone = document.getElementById(id);
                zone.innerHTML = '';
                (snapshot.val()?.players || []).forEach(p => zone.appendChild(createPlayerDOM(p.name, p.gender)));
            });
        });

        function createPlayerDOM(name, gender) {
            const div = document.createElement('div');
            div.className = `player ${gender === 'M' ? 'male' : 'female'}`;
            div.dataset.name = name; div.dataset.gender = gender;
            const s = todayStats[name] || { wins: 0, total: 0 };
            div.innerHTML = `<div>${name}<span class="win-rate">${s.total ? Math.round((s.wins/s.total)*100) : 0}%</span></div>`;
            div.onclick = () => {
                if(isDeleteMode) { if(confirm(`ç¢ºå®šç§»é™¤ ${name}ï¼Ÿ`)) { div.remove(); syncToDB(); } }
                else if(div.parentElement.id.includes('court')) div.classList.toggle('winner');
            };
            return div;
        }

        function syncToDB() {
            allZones.forEach(id => {
                const players = [...document.getElementById(id).querySelectorAll('.player')].map(p => ({ name: p.dataset.name, gender: p.dataset.gender }));
                set(ref(db, id), { players });
            });
            set(ref(db, 'today_stats'), todayStats);
        }

        allZones.forEach(id => {
            Sortable.create(document.getElementById(id), {
                group: 'players', animation: 150,
                onStart: () => isLocalMoving = true,
                onMove: (evt) => { 
                    const limit = (evt.to.id.includes('court') || evt.to.id.includes('waiting')) ? 4 : 99;
                    if (evt.to.children.length >= limit) return false; 
                },
                onEnd: () => { isLocalMoving = false; syncToDB(); }
            });
        });

        window.endMatch = function(courtId) {
            const courtZone = document.getElementById(courtId + '-zone');
            const players = [...courtZone.querySelectorAll('.player')];
            if(players.length === 0) return;
            const winners = players.filter(p => p.classList.contains('winner')).map(p => p.dataset.name);
            const losers = players.filter(p => !p.classList.contains('winner')).map(p => p.dataset.name);
            
            if(winners.length > 0) push(ref(db, 'match_logs'), { 
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), 
                winners: winners.join(', '), losers: losers.join(', ') 
            });

            players.forEach(p => {
                const name = p.dataset.name;
                if(!todayStats[name]) todayStats[name] = { wins: 0, total: 0 };
                if(!historyStats[name]) historyStats[name] = { wins: 0, total: 0, gender: p.dataset.gender };
                todayStats[name].total++; historyStats[name].total++;
                if(winners.includes(name)) { todayStats[name].wins++; historyStats[name].wins++; }
                document.getElementById('bench-zone').appendChild(p);
                p.classList.remove('winner');
            });
            autoShift(); syncToDB(); set(ref(db, 'history_stats'), historyStats);
        };

        function autoShift() {
            courtZones.forEach(cID => {
                const court = document.getElementById(cID + '-zone');
                const waitA = document.getElementById('waitingA-zone');
                while (court.children.length < 4 && waitA.children.length > 0) court.appendChild(waitA.children[0]);
            });
            for (let i = 0; i < waitZones.length - 1; i++) {
                const current = document.getElementById(waitZones[i] + '-zone');
                const next = document.getElementById(waitZones[i+1] + '-zone');
                while (current.children.length < 4 && next.children.length > 0) current.appendChild(next.children[0]);
            }
        }

        window.toggleDeleteMode = function() {
            isDeleteMode = !isDeleteMode;
            const btn = document.getElementById('delBtn');
            btn.classList.toggle('active');
            btn.textContent = isDeleteMode ? "ğŸ›‘ åœæ­¢åˆªé™¤" : "ğŸ—‘ï¸ åˆªé™¤æ¨¡å¼";
        };

        window.addPlayer = function() {
            const name = document.getElementById('newPlayer').value.trim();
            const gender = document.getElementById('gender').value;
            if(!name) return;
            document.getElementById('bench-zone').appendChild(createPlayerDOM(name, gender));
            document.getElementById('newPlayer').value = '';
            syncToDB();
        };

        window.resetToday = function() { if(confirm('ç¢ºå®šé‡ç½®ä»Šæ—¥ç´€éŒ„èˆ‡æ’éšŠç‹€æ³ï¼Ÿ')) { set(ref(db,'today_stats'),{}); set(ref(db,'match_logs'),{}); allZones.forEach(id=>set(ref(db,id),{players:[]})); } };
        window.resetEverything = function() { const pw = prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ä»¥æ¸…é™¤æ‰€æœ‰æ­·å²ç´€éŒ„ï¼š"); if(pw==="60540391") remove(ref(db,'/')).then(()=>location.reload()); };

        // æ¨™é¡Œé€£é» 3 ä¸‹é¡¯ç¤º/éš±è—å¾Œå°æŒ‰éˆ•
        document.getElementById('mainTitle').onclick = (function() {
            let count = 0, timer;
            return function() {
                count++;
                clearTimeout(timer);
                if(count >= 3) {
                    const admin = document.getElementById('adminControls');
                    admin.style.display = (admin.style.display === 'none') ? 'flex' : 'none';
                    count = 0;
                }
                timer = setTimeout(() => count = 0, 1000);
            };
        })();

        // æ’è¡Œæ¦œèˆ‡æ—¥èªŒ
        document.getElementById('showLogBtn').onclick = () => {
            document.getElementById('logContent').innerHTML = logs.map(l => `<div style="padding:10px; border-bottom:1px solid #eee; font-size:14px;"><b>[${l.time}]</b> å‹ï¼š${l.winners} / æ•—ï¼š${l.losers}</div>`).join('') || 'å°šç„¡ç´€éŒ„';
            document.getElementById('logModal').style.display = 'block';
        };

        document.getElementById('showRankBtn').onclick = () => {
            const all = Object.entries(historyStats).map(([name, s]) => ({ name, ...s, rate: s.total ? Math.round((s.wins/s.total)*100) : 0 }));
            const buildRank = (players, title) => {
                const sorted = players.sort((a,b) => b.wins - a.wins || b.rate - a.rate);
                return `<div style="background:var(--accent);color:white;padding:8px;margin-top:10px;border-radius:5px;">${title}</div><table class="rank-table">` + 
                    sorted.map((p,i) => `<tr><td>${i+1}</td><td>${p.name}</td><td>${p.wins}å‹</td><td>${p.rate}%</td></tr>`).join('') + `</table>`;
            };
            document.getElementById('rankContent').innerHTML = buildRank(all.filter(p=>p.gender==='M'), 'ğŸ† ç”·å­æ¦œ') + buildRank(all.filter(p=>p.gender==='F'), 'ğŸŒ¸ å¥³å­æ¦œ');
            document.getElementById('rankModal').style.display = 'block';
        };

        function refreshWinRates() {
            document.querySelectorAll('.player').forEach(p => {
                const s = todayStats[p.dataset.name] || { wins: 0, total: 0 };
                const rateSpan = p.querySelector('.win-rate');
                if(rateSpan) rateSpan.textContent = `${s.total ? Math.round((s.wins / s.total) * 100) : 0}%`;
            });
        }
    </script>
</body>
</html>
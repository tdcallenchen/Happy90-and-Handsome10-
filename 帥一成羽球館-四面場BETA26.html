<!DOCTYPE html><html lang="zh-TW"><head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">    <title>å¿«æ¨‚ä¹æˆå¸¥ä¸€æˆ</title>    <style>        :root {            --bg: #cce7ff; --accent: #e25b77; --dark: #000; --light: #fff;             --male: #8fc1ff; --female: #ffb6c1; --winner: #3cb371; --border-radius: 12px;            color-scheme: light;        }        html, body { margin: 0; padding: 0; background: var(--bg); font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; min-height: 100vh; overflow-x: hidden; }        body { display: flex; flex-direction: column; padding: 10px; box-sizing: border-box; }        @media (min-width: 1200px) and (orientation: landscape) {            html, body { height: 100vh; overflow: hidden; }            .container { height: calc(100vh - 120px); }            .player-zone { overflow-y: auto; }        }        @media (orientation: portrait) {            .container { display: flex; flex-direction: column; gap: 15px; }            .courts, .waiting { grid-template-columns: repeat(2, 1fr) !important; }        }
        h1 { text-align: center; color: var(--accent); cursor: pointer; margin: 5px 0; user-select: none; }        #controls, #adminControls { display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; margin-bottom: 8px; }        #adminControls { display: none; background: rgba(255, 255, 255, 0.9); padding: 8px; border-radius: var(--border-radius); border: 2px solid var(--accent); }        input, select, button { padding: 6px; border-radius: 8px; border: 1px solid var(--accent); font-size: 14px; }        button { background-color: var(--accent); color: white; font-weight: bold; cursor: pointer; border: none; }
        .container { display: grid; grid-template-columns: 200px 1fr; gap: 10px; flex-grow: 1; }        .area { background: var(--light); border: 3px solid var(--accent); border-radius: var(--border-radius); padding: 8px; display: flex; flex-direction: column; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }        .area h3 { text-align: center; color: var(--accent); margin: 0 0 5px 0; border-bottom: 2px dashed var(--bg); }        .player-zone { flex-grow: 1; display: flex; flex-direction: column; gap: 5px; min-height: 50px; }        #bench-zone { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; align-content: flex-start; }
        .player { position: relative; width: 100%; height: 42px; background: #fff; border: 2px solid var(--accent); border-radius: 8px; font-weight: 900; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: grab; user-select: none; color: #000; box-sizing: border-box; }        .player.male { background: var(--male); } .player.female { background: var(--female); }        .player.winner { background-color: var(--winner) !important; color: white !important; }        .win-info { font-size: 10px; opacity: 0.8; font-weight: normal; }
        .right-side { display: flex; flex-direction: column; gap: 10px; }        .courts, .waiting { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }        .end-btn { width: 100%; margin-top: 4px; padding: 4px; font-size: 12px; background: #444; color: white; border-radius: 5px; cursor: pointer; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95%; max-width: 500px; background: white; border-radius: 20px; padding: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.5); z-index: 2000; border: 3px solid var(--accent); color: #000; }        .modal-content { max-height: 60vh; overflow-y: auto; }        .rank-table { width: 100%; border-collapse: collapse; margin-top: 5px; }        .rank-table td { padding: 8px 4px; border-bottom: 1px solid #eee; font-size: 14px; }        .rank-header { background: var(--accent); color: white; padding: 6px; text-align: center; border-radius: 5px; font-weight: bold; margin-top: 10px; }    </style></head><body>

<h1 id="mainTitle">å¿«æ¨‚ä¹æˆå¸¥ä¸€æˆ</h1>
<div id="controls">    <input type="text" id="newPlayer" placeholder="å§“å" style="width: 80px;">    <select id="gender"><option value="M">ç”·</option><option value="F">å¥³</option></select>    <button onclick="addPlayer()">æ–°å¢</button>    <button id="delBtn" onclick="toggleDeleteMode()">ğŸ—‘ï¸ åˆªé™¤æ¨¡å¼</button></div>
<div id="adminControls">    <button id="showLogBtn" style="background:#2196F3">ğŸ“‹ ä»Šæ—¥ç´€éŒ„</button>    <button id="showRankBtn" style="background:#2196F3">ğŸ† æ’è¡Œæ¦œ</button>    <button onclick="exportToCSV()" style="background:#4CAF50">åŒ¯å‡ºå ±è¡¨</button>    <button onclick="resetToday()" style="background:#ffa000">ğŸ”„ é‡ç½®ä»Šæ—¥</button>    <button onclick="resetEverything()" style="background:#d32f2f">ğŸ’€ é‡ç½®æ­·å²</button></div>
<div class="container">    <div class="area" id="bench"><h3>ä¼‘æ¯å€</h3><div class="player-zone" id="bench-zone"></div></div>    <div class="right-side">        <div class="courts">            <div class="area" id="court1"><h3>1 è™Ÿå ´</h3><div class="player-zone" id="court1-zone"></div><button class="end-btn" onclick="endMatch('court1')">çµæŸ</button></div>            <div class="area" id="court2"><h3>2 è™Ÿå ´</h3><div class="player-zone" id="court2-zone"></div><button class="end-btn" onclick="endMatch('court2')">çµæŸ</button></div>            <div class="area" id="court3"><h3>3 è™Ÿå ´</h3><div class="player-zone" id="court3-zone"></div><button class="end-btn" onclick="endMatch('court3')">çµæŸ</button></div>            <div class="area" id="court4"><h3>4 è™Ÿå ´</h3><div class="player-zone" id="court4-zone"></div><button class="end-btn" onclick="endMatch('court4')">çµæŸ</button></div>        </div>        <div class="waiting">            <div class="area" id="waitingA"><h3>ç­‰å¾… 1</h3><div class="player-zone" id="waitingA-zone"></div></div>            <div class="area" id="waitingB"><h3>ç­‰å¾… 2</h3><div class="player-zone" id="waitingB-zone"></div></div>            <div class="area" id="waitingC"><h3>ç­‰å¾… 3</h3><div class="player-zone" id="waitingC-zone"></div></div>            <div class="area" id="waitingD"><h3>ç­‰å¾… 4</h3><div class="player-zone" id="waitingD-zone"></div></div>        </div>    </div></div>

<div id="rankModal" class="modal"><h3>ğŸ† æ­·å²æ’è¡Œæ¦œ</h3><div id="rankContent" class="modal-content"></div><button onclick="this.parentElement.style.display='none'" style="width:100%; margin-top:10px;">é—œé–‰</button></div>
<div id="logModal" class="modal"><h3>ğŸ“‹ ä»Šæ—¥å°æˆ°ç´€éŒ„</h3><div id="logContent" class="modal-content"></div><button onclick="this.parentElement.style.display='none'" style="width:100%; margin-top:10px;">é—œé–‰</button></div>

<script type="module">    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";    import { getDatabase, ref, set, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";    import Sortable from "https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/+esm";

    const firebaseConfig = { apiKey: "AIzaSyCLUmagiUpLd0qRUQ-TyoFt7hwrNK7xVDY", databaseURL: "https://havix-b6fe2-default-rtdb.firebaseio.com" };    const app = initializeApp(firebaseConfig); const db = getDatabase(app);    const zones = ['bench-zone', 'court1-zone', 'court2-zone', 'court3-zone', 'court4-zone', 'waitingA-zone', 'waitingB-zone', 'waitingC-zone', 'waitingD-zone'];    let todayStats = {}, historyStats = {}, logs = [], isLocalMoving = false, isDeleteMode = false;

    onValue(ref(db, '/'), (snapshot) => {        if (isLocalMoving) return;        const data = snapshot.val() || {};        todayStats = data.today_stats || {};        historyStats = data.history_stats || {};        logs = data.match_logs ? Object.values(data.match_logs).reverse() : [];
        zones.forEach(id => {            const el = document.getElementById(id); if (!el) return;            el.innerHTML = '';            (data[id]?.players || []).forEach(p => el.appendChild(createPlayerDOM(p.name, p.gender)));        });    });

    function createPlayerDOM(name, gender) {        const div = document.createElement('div');        div.className = `player ${gender === 'M' ? 'male' : 'female'}`;        div.dataset.name = name; div.dataset.gender = gender;
        const s = todayStats[name] || { wins: 0, total: 0 };
        const rate = s.total ? Math.round((s.wins / s.total) * 100) : 0;
        div.innerHTML = `<span>${name}</span><span class="win-info">${rate}%</span>`;

        div.onclick = () => {            if (isDeleteMode) { if (confirm(`ç¢ºå®šç§»é™¤ ${name}ï¼Ÿ`)) { div.remove(); sync(); } return; }            if (div.parentElement.id.includes('court')) {                const winners = div.parentElement.querySelectorAll('.player.winner');                if (winners.length >= 2 && !div.classList.contains('winner')) return;                div.classList.toggle('winner');            }        };        return div;    }

    zones.forEach(id => {        const el = document.getElementById(id); if (!el) return;        Sortable.create(el, {            group: 'players', animation: 150,            onStart: () => { isLocalMoving = true; },            onMove: (evt) => { if (evt.to.id !== 'bench-zone' && evt.to.children.length >= 4) return false; },            onEnd: () => { isLocalMoving = false; sync(); }        });    });

    function sync() {        const updates = {};        zones.forEach(id => { updates[id] = { players: [...document.getElementById(id).querySelectorAll('.player')].map(p => ({ name: p.dataset.name, gender: p.dataset.gender })) }; });        updates['today_stats'] = todayStats;        updates['history_stats'] = historyStats;        update(ref(db, '/'), updates);    }

    window.addPlayer = function() {        const nameInput = document.getElementById('newPlayer');        const name = nameInput.value.trim();        if (!name) return;        document.getElementById('bench-zone').appendChild(createPlayerDOM(name, document.getElementById('gender').value));        nameInput.value = ''; sync();    };

    window.endMatch = function(courtId) {        const zone = document.getElementById(courtId + '-zone');        const ps = [...zone.querySelectorAll('.player')];        const ws = ps.filter(p => p.classList.contains('winner'));
        if (ws.length !== 2) return alert("è«‹é¸æ“‡ 2 ä½è´å®¶");
        const winNs = ws.map(p => p.dataset.name);        const loseNs = ps.filter(p => !winNs.includes(p.dataset.name)).map(p => p.dataset.name);
        ps.forEach(p => {            const n = p.dataset.name;            if (!todayStats[n]) todayStats[n] = { wins: 0, total: 0 };            if (!historyStats[n]) historyStats[n] = { wins: 0, total: 0, gender: p.dataset.gender };            todayStats[n].total++; historyStats[n].total++;
            if (winNs.includes(n)) { todayStats[n].wins++; historyStats[n].wins++; }
            p.classList.remove('winner');            document.getElementById('bench-zone').appendChild(p);        });

        const newLogRef = push(ref(db, 'match_logs'));
        const updates = {};
        updates[`match_logs/${newLogRef.key}`] = { time: new Date().toLocaleTimeString('zh-TW', {hour12:false, hour:'2-digit', minute:'2-digit'}), winners: winNs.join('ã€'), losers: loseNs.join('ã€') };
        const waitOrder = ['waitingA-zone', 'waitingB-zone', 'waitingC-zone', 'waitingD-zone'];        let target = zone;
        waitOrder.forEach(sid => {            const source = document.getElementById(sid);            while (target.children.length < 4 && source.children.length > 0) target.appendChild(source.children[0]);            target = source;        });
        zones.forEach(id => { updates[id] = { players: [...document.getElementById(id).querySelectorAll('.player')].map(p => ({ name: p.dataset.name, gender: p.dataset.gender })) }; });
        updates['today_stats'] = todayStats;        updates['history_stats'] = historyStats;
        update(ref(db, '/'), updates);    };

    window.toggleDeleteMode = function() { isDeleteMode = !isDeleteMode; document.getElementById('delBtn').textContent = isDeleteMode ? "ğŸ›‘ åœæ­¢" : "ğŸ—‘ï¸ åˆªé™¤æ¨¡å¼"; };

    // å¯†ç¢¼ä¿è­·ï¼šé»æ“Š 3 æ¬¡æ¨™é¡Œå¾Œè¦æ±‚è¼¸å…¥å¯†ç¢¼
    document.getElementById('mainTitle').onclick = (function() {        let count = 0, timer;        return function() {            count++;            if(count >= 3) {                const admin = document.getElementById('adminControls');                if (admin.style.display === 'flex') {                    admin.style.display = 'none';                } else {                    if (prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ï¼š") === "60540391") {                        admin.style.display = 'flex';                    } else {                        alert("å¯†ç¢¼éŒ¯èª¤ï¼");                    }                }                count = 0;            }            clearTimeout(timer); timer = setTimeout(() => count = 0, 1000);        };    })();

    document.getElementById('showRankBtn').onclick = () => {
        const all = Object.entries(historyStats).map(([name, s]) => ({ name, ...s, rate: s.total ? Math.round((s.wins/s.total)*100) : 0 }));
        const buildTable = (players, title) => {
            const sorted = players.sort((a,b)=>(b.wins-a.wins)||(b.rate-a.rate));
            let h = `<div class="rank-header">${title}</div><table class="rank-table">`;
            sorted.forEach((p, i) => {
                h += `<tr><td style="width:25px;color:#888;">${i+1}</td><td style="width:80px"><b>${p.name}</b></td><td>${p.wins} (${p.total})</td><td>${p.rate}%</td><td style="text-align:right"><button onclick="deleteFromHistory('${p.name}')" style="background:none;color:red;padding:2px;">ğŸ—‘ï¸</button></td></tr>`;
            });
            return h + `</table>`;
        };
        document.getElementById('rankContent').innerHTML = buildTable(all.filter(p=>p.gender==='M'), 'ğŸ† ç”·å­æ¦œ') + buildTable(all.filter(p=>p.gender==='F'), 'ğŸŒ¸ å¥³å­æ¦œ');
        document.getElementById('rankModal').style.display = 'block';
    };

    window.deleteFromHistory = function(name) {        if (prompt(`æ°¸ä¹…åˆªé™¤ ${name} çš„æ­·å²æ•¸æ“šï¼Ÿè«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ï¼š`) === "60540391") {            delete historyStats[name];            const up = {}; up['history_stats'] = historyStats;            update(ref(db, '/'), up).then(() => document.getElementById('showRankBtn').click());        }    };

    document.getElementById('showLogBtn').onclick = () => {        document.getElementById('logContent').innerHTML = logs.map(l => `<div style="padding:10px; border-bottom:1px solid #eee; font-size:14px;"><b>[${l.time}]</b><br><span style="color:var(--winner)">å‹ï¼š${l.winners}</span><br><span style="color:var(--accent)">æ•—ï¼š${l.losers}</span></div>`).join('') || 'å°šç„¡ç´€éŒ„';        document.getElementById('logModal').style.display = 'block';    };

    window.exportToCSV = function() {        let csv = "\uFEFFæ™‚é–“,è´å®¶,è¼¸å®¶\n" + logs.map(l => `${l.time},"${l.winners}","${l.losers}"`).join('\n');        const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' })); a.download = `æˆ°å ±_${new Date().toLocaleDateString()}.csv`; a.click();    };

    window.resetToday = function() {        if (confirm("é‡ç½®ä»Šæ—¥ï¼Ÿé€™å°‡ç§»é™¤å ´ä¸Šæ‰€æœ‰äººä¸¦æ¸…ç©ºä»Šæ—¥æˆ°ç¸¾ã€‚")) {            const up = {}; up['today_stats'] = {}; up['match_logs'] = {};            zones.forEach(id => up[id] = { players: [] });            update(ref(db, '/'), up);        }    };

    window.resetEverything = function() { if (prompt("å¯†ç¢¼ï¼š") === "60540391") { remove(ref(db, '/')).then(() => location.reload()); } };
</script></body></html>